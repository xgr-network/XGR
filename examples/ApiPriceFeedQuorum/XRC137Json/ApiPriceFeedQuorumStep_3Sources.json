{
  "apiCalls": [
    {
      "contentType": "json",
      "extractMap": {
        "FetchedCoinbase": {
          "default": 0.0,
          "type": "double",
          "value": "double(resp.data.amount)"
        },
        "OkCoinbase": {
          "default": false,
          "type": "bool",
          "value": "double(resp.data.amount) > 0.0"
        }
      },
      "headers": {
        "Accept": "application/json"
      },
      "method": "GET",
      "name": "coinbase_spot",
      "urlTemplate": "https://api.coinbase.com/v2/prices/BTC-USD/spot"
    },
    {
      "contentType": "json",
      "extractMap": {
        "FetchedBitstamp": {
          "default": 0.0,
          "type": "double",
          "value": "double(resp.last)"
        },
        "OkBitstamp": {
          "default": false,
          "type": "bool",
          "value": "double(resp.last) > 0.0"
        }
      },
      "headers": {
        "Accept": "application/json"
      },
      "method": "GET",
      "name": "bitstamp_ticker",
      "urlTemplate": "https://www.bitstamp.net/api/v2/ticker/btcusd"
    },
    {
      "contentType": "json",
      "extractMap": {
        "FetchedGecko": {
          "default": 0.0,
          "type": "double",
          "value": "double(resp.bitcoin.usd)"
        },
        "OkGecko": {
          "default": false,
          "type": "bool",
          "value": "double(resp.bitcoin.usd) > 0.0"
        }
      },
      "headers": {
        "Accept": "application/json"
      },
      "method": "GET",
      "name": "coingecko_simple_price",
      "urlTemplate": "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd"
    }
  ],

  "payload": {
    "Base": {
      "default": "BTC",
      "type": "string"
    },
    "Quote": {
      "default": "USD",
      "type": "string"
    },
    "Seq": {
      "default": 0,
      "type": "int64"
    },
    "PrevPrice": {
      "default": 0.0,
      "type": "double"
    },
    "MaxDeltaPct": {
      "default": 0.2,
      "type": "double"
    },
    "QuorumTolPct": {
      "default": 0.01,
      "type": "double"
    },

    "CoinbasePrice": {
      "default": 0.0,
      "type": "double"
    },
    "BitstampPrice": {
      "default": 0.0,
      "type": "double"
    },
    "GeckoPrice": {
      "default": 0.0,
      "type": "double"
    },
    "ConsensusPrice": {
      "default": 0.0,
      "type": "double"
    },
    "DeltaPct": {
      "default": 0.0,
      "type": "double"
    },
    "QuorumPair": {
      "default": "",
      "type": "string"
    },

    "Ok": {
      "default": false,
      "type": "bool"
    },
    "Error": {
      "default": "",
      "type": "string"
    },
    "Source": {
      "default": "quorum_3api",
      "type": "string"
    }
  },

  "rules": [
    "(([OkCoinbase] == true) && ([OkBitstamp] == true) && (abs([FetchedCoinbase] - [FetchedBitstamp]) / (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) <= [QuorumTolPct])) || (([OkCoinbase] == true) && ([OkGecko] == true) && (abs([FetchedCoinbase] - [FetchedGecko]) / (([FetchedCoinbase] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) || (([OkBitstamp] == true) && ([OkGecko] == true) && (abs([FetchedBitstamp] - [FetchedGecko]) / (([FetchedBitstamp] + [FetchedGecko]) / 2.0) <= [QuorumTolPct]))",
    "((([OkCoinbase] == true) && ([OkBitstamp] == true) && (abs([FetchedCoinbase] - [FetchedBitstamp]) / (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) <= [QuorumTolPct])) ? (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) : ((([OkCoinbase] == true) && ([OkGecko] == true) && (abs([FetchedCoinbase] - [FetchedGecko]) / (([FetchedCoinbase] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? (([FetchedCoinbase] + [FetchedGecko]) / 2.0) : ((([OkBitstamp] == true) && ([OkGecko] == true) && (abs([FetchedBitstamp] - [FetchedGecko]) / (([FetchedBitstamp] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? (([FetchedBitstamp] + [FetchedGecko]) / 2.0) : 0.0))) > 0.0",
    "([PrevPrice] == 0.0) || (abs(((([OkCoinbase] == true) && ([OkBitstamp] == true) && (abs([FetchedCoinbase] - [FetchedBitstamp]) / (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) <= [QuorumTolPct])) ? (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) : ((([OkCoinbase] == true) && ([OkGecko] == true) && (abs([FetchedCoinbase] - [FetchedGecko]) / (([FetchedCoinbase] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? (([FetchedCoinbase] + [FetchedGecko]) / 2.0) : ((([OkBitstamp] == true) && ([OkGecko] == true) && (abs([FetchedBitstamp] - [FetchedGecko]) / (([FetchedBitstamp] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? (([FetchedBitstamp] + [FetchedGecko]) / 2.0) : 0.0)))) - [PrevPrice]) / [PrevPrice] <= [MaxDeltaPct])"
  ],

  "onValid": {
    "payload": {
      "Seq": "int64([Seq]) + 1",
      "Pair": "[Base]-[Quote]",

      "CoinbasePrice": "[FetchedCoinbase]",
      "BitstampPrice": "[FetchedBitstamp]",
      "GeckoPrice": "[FetchedGecko]",

      "ConsensusPrice": "((([OkCoinbase] == true) && ([OkBitstamp] == true) && (abs([FetchedCoinbase] - [FetchedBitstamp]) / (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) <= [QuorumTolPct])) ? (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) : ((([OkCoinbase] == true) && ([OkGecko] == true) && (abs([FetchedCoinbase] - [FetchedGecko]) / (([FetchedCoinbase] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? (([FetchedCoinbase] + [FetchedGecko]) / 2.0) : ((([OkBitstamp] == true) && ([OkGecko] == true) && (abs([FetchedBitstamp] - [FetchedGecko]) / (([FetchedBitstamp] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? (([FetchedBitstamp] + [FetchedGecko]) / 2.0) : 0.0)))",

      "QuorumPair": "((([OkCoinbase] == true) && ([OkBitstamp] == true) && (abs([FetchedCoinbase] - [FetchedBitstamp]) / (([FetchedCoinbase] + [FetchedBitstamp]) / 2.0) <= [QuorumTolPct])) ? \"CB\" : ((([OkCoinbase] == true) && ([OkGecko] == true) && (abs([FetchedCoinbase] - [FetchedGecko]) / (([FetchedCoinbase] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? \"CG\" : ((([OkBitstamp] == true) && ([OkGecko] == true) && (abs([FetchedBitstamp] - [FetchedGecko]) / (([FetchedBitstamp] + [FetchedGecko]) / 2.0) <= [QuorumTolPct])) ? \"BG\" : \"\")))",

      "DeltaPct": "([PrevPrice] == 0.0) ? 0.0 : (abs([ConsensusPrice] - [PrevPrice]) / [PrevPrice])",

      "PrevPrice": "[ConsensusPrice]",
      "Ok": true,
      "Error": "",
      "Source": "quorum_3api"
    },
    "waitSec": 3600
  },

  "onInvalid": {
    "payload": {
      "Seq": "int64([Seq]) + 1",
      "Pair": "[Base]-[Quote]",

      "CoinbasePrice": "[FetchedCoinbase]",
      "BitstampPrice": "[FetchedBitstamp]",
      "GeckoPrice": "[FetchedGecko]",

      "ConsensusPrice": "0.0",
      "DeltaPct": "0.0",
      "QuorumPair": "",

      "Ok": false,
      "Error": "Quorum failed or delta guard triggered",
      "Source": "quorum_3api"
    },
    "waitSec": 3600
  }
}
